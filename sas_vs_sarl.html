<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparateur SARL vs SAS - Salaire net et droits à la retraite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .container {
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        #totalCostInput {
            text-align: right;
            width: 200px;
        }
        .disclaimer {
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="alert alert-info disclaimer mb-4">
            Les calculs présentés sont à titre indicatif. Les résultats peuvent varier en fonction de votre situation personnelle et fiscale.
        </div>
        <h1 class="mb-4">Comparateur SARL vs SAS - Salaire net et droits à la retraite</h1>
        <form id="comparisonForm">
            <div class="mb-3">
                <label for="totalCostInput" class="form-label">Coût total disponible pour la rémunération :</label>
                <div class="d-flex align-items-center">
                    <input type="text" id="totalCostInput" class="form-control me-2" required>
                    <button type="submit" class="btn btn-primary" id="compareButton">Comparer</button>
                </div>
            </div>
        </form>
        
        <div id="result" class="mt-4" style="display: none;">
            <h2>Résultats de la comparaison</h2>
            <canvas id="comparisonChart"></canvas>
            <div id="comparisonDetails" class="mt-4"></div>
        </div>
        <div id="loading" class="mt-4" style="display: none;">
            <p>Analyse en cours, veuillez patienter...</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
        <div id="error" class="mt-4 alert alert-danger" style="display: none;"></div>
    </div>

    <script>
        let comparisonChart = null; // Declare this variable at the top of your script, outside any function

        $(document).ready(function() {
            $('#totalCostInput').on('input', function() {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value, 10);
                    $(this).val(value.toLocaleString('fr-FR') + ' €');
                }
            });

            $('#comparisonForm').on('submit', function(e) {
                e.preventDefault();
                const totalCost = parseInt($('#totalCostInput').val().replace(/[^0-9]/g, ''));
                $('#result').hide();
                $('#comparisonDetails').empty();
                $('#loading').show();
                $('#error').hide();
                compareStatuses(totalCost);
            });
        });

        function compareStatuses(totalCost) {
            const apiUrl = 'https://mon-entreprise.urssaf.fr/api/v1/evaluate';
            const results = {
                SARL: [],
                SAS: []
            };

            Promise.all([
                calculateSARL(apiUrl, totalCost, results),
                calculateSAS(apiUrl, totalCost, results)
            ]).then(() => {
                displayResults(results, totalCost);
            }).catch((error) => {
                console.error('Error in calculations:', error);
                $('#loading').hide();
                $('#error').show().text('Une erreur est survenue lors de l\'analyse. Veuillez réessayer plus tard.');
            });
        }

        function calculateSARL(apiUrl, totalCost, results) {
            const data = {
                "expressions": [
                    "dirigeant . rémunération . net",
                    "protection sociale . retraite . base",
                    "protection sociale . retraite . complémentaire . RCI"
                ],
                "situation": {
                    "entreprise . imposition": "'IS'",
                    "entreprise . associés": "'unique'",
                    "entreprise . catégorie juridique": "'SARL'",
                    "dirigeant . rémunération . totale": totalCost
                }
            };

            return $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data)
            }).then(function(response) {
                const netSalary = response.evaluate[0].nodeValue;
                const baseRetirementMonthlyAmount = response.evaluate[1].nodeValue;
                // The complementary retirement amount is calculated per squared year,
                // which means that for each year of work, you get the amount returned per year when you retire
                const complementaryRetirementAmount = response.evaluate[2].nodeValue * 43;
                results.SARL.push({
                    salary: totalCost,
                    netSalary: netSalary,
                    baseRetirementYearlyAmount: baseRetirementMonthlyAmount * 12,
                    complementaryRetirementAmount: complementaryRetirementAmount
                });
            });
        }

        function calculateSAS(apiUrl, totalCost, results) {
            const data = {
                "expressions": [
                    "salarié . rémunération . net",
                    "protection sociale . retraite . base",
                    "protection sociale . retraite . complémentaire"
                ],
                "situation": {
                    "salarié . activité partielle": "non",
                    "salarié . coût total employeur": totalCost,
                    "dirigeant": "oui"
                }
            };

            return $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data)
            }).then(function(response) {
                // Net salary is returned per month so we multiply by 12 to get the annual net salary
                const netSalary = response.evaluate[0].nodeValue * 12;
                const baseRetirementMonthlyAmount = response.evaluate[1].nodeValue;
                // The complementary retirement amount is returned per ten years per month,
                // which means that for every 10 years of work, you get the amount returned per month when you retire
                // so we multiply by 4.3 to get the amount after 43 years, and by 12 to get the yearly amount
                const complementaryRetirementAmount = response.evaluate[2].nodeValue * 4.3 * 12;
                results.SAS.push({
                    salary: totalCost,
                    netSalary: netSalary,
                    baseRetirementYearlyAmount: baseRetirementMonthlyAmount * 12,
                    complementaryRetirementAmount: complementaryRetirementAmount
                });
            });
        }

        function displayResults(results, totalCost) {
            // Destroy the existing chart if it exists
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['SARL', 'SAS'],
                    datasets: [
                        {
                            label: 'Salaire net',
                            data: [results.SARL[0].netSalary, results.SAS[0].netSalary],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        },
                        {
                            label: 'Retraite base',
                            data: [results.SARL[0].baseRetirementYearlyAmount, results.SAS[0].baseRetirementYearlyAmount],
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        },
                        {
                            label: 'Retraite complémentaire',
                            data: [results.SARL[0].complementaryRetirementAmount, results.SAS[0].complementaryRetirementAmount],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Montant en euros'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            $('#comparisonDetails').html(`
                <h3>Détails de la comparaison</h3>
                <table class="table table-striped">
                    <thead>
                        <tr class="table-primary">
                            <th scope="col"></th>
                            <th scope="col">SARL</th>
                            <th scope="col">SAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Coût total</th>
                            <td>${totalCost.toLocaleString('fr-FR')} €/an</td>
                            <td>${totalCost.toLocaleString('fr-FR')} €/an</td>
                        </tr>
                        <tr>
                            <th scope="row">Salaire net</th>
                            <td>${Math.round(results.SARL[0].netSalary).toLocaleString('fr-FR')} €/an</td>
                            <td>${Math.round(results.SAS[0].netSalary).toLocaleString('fr-FR')} €/an</td>
                        </tr>
                        <tr>
                            <th scope="row">Retraite base</th>
                            <td>${Math.round(results.SARL[0].baseRetirementYearlyAmount).toLocaleString('fr-FR')} €/an</td>
                            <td>${Math.round(results.SAS[0].baseRetirementYearlyAmount).toLocaleString('fr-FR')} €/an</td>
                        </tr>
                        <tr>
                            <th scope="row">Retraite complémentaire</th>
                            <td>${Math.round(results.SARL[0].complementaryRetirementAmount).toLocaleString('fr-FR')} €/an</td>
                            <td>${Math.round(results.SAS[0].complementaryRetirementAmount).toLocaleString('fr-FR')} €/an</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info mt-4">
                    <h5>Avertissement sur les calculs de retraite</h5>
                    <p>Les montants de retraite présentés ci-dessus sont basés sur les hypothèses suivantes :</p>
                    <ul>
                        <li>Une carrière complète de 43 ans au même niveau de salaire.</li>
                        <li>Les calculs ne prennent pas en compte les évolutions potentielles de salaire ou les changements de statut au cours de la carrière.</li>
                    </ul>
                    <p>Ces calculs sont fournis à titre indicatif pour illustrer les mécanismes et les variations des droits sociaux selon le statut choisi (SARL ou SAS). Ils ne doivent pas être considérés comme une projection précise des droits à la retraite.</p>
                    <p>Pour une estimation plus précise de vos droits à la retraite, nous vous recommandons de consulter un expert-comptable ou un conseiller en protection sociale.</p>
                </div>
            `);

            $('#result').show();
            $('#loading').hide();
        }
    </script>
</body>
</html>